var objMap = {
    id: 0,
    name: "线路1", //路线名字
    spotnum: 8, //设备点数
    specified: true, //是否固定
    arrangeable: false, //是否自由
    desc: "", //路线描述
    created_at: "", //路线创建时间
    updated_at: "", //路线修改时间  //这条路线的各个点
    spots: [{
        id: 1,
        name: "asd",
        desc: "asd",
        tmp: false,
        created_at: "",
        updated_at: "",
        checked: true, //true 查过了   false 未查
        items: [{
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "0",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50", //当前值
            value: true,
            pass: false
        }]
    }, {
        id: 1,
        name: "asd",
        desc: "asd",
        tmp: true,
        created_at: "",
        updated_at: "",
        checked: true,
        items: [{
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            value: false,
            pass: true
        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            value: false,
            pass: true

        }]
    }, {
        id: 1,
        name: "asd",
        desc: "asd",
        tmp: false,
        created_at: "",
        updated_at: "",
        checked: true,
        items: [{
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            value: true,
            pass: true
        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            value: true,
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            data: "50",
            value: false,
            pass: false,
            updated_at: "巡检条目修改时间"
        }]
    }, {
        id: 1,
        name: "asd",
        desc: "asd",
        tmp: false,
        created_at: "",
        updated_at: "",
        checked: true,
        items: [{
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            pass: false

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            value: false,
            pass: true

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            updated_at: "巡检条目修改时间",
            data: "50",
            value: false,
            pass: true

        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            data: "50",
            value: false,
            pass: false,

            updated_at: "巡检条目修改时间"
        }, {
            id: "1",
            content: "内容",
            unit: "位",
            itemtype: "1",
            st_min: "23",
            st_max: "45",
            al_min: "30",
            al_max: "40",
            created_at: "巡检条目创建时间",
            data: "50",
            value: false,
            pass: true,

            updated_at: "巡检条目修改时间"
        }]
    }]
};

$(document).ready(function () {
    $('.pop-close').click(function () {
        $('#kuang3').hide();
        $('.bgPop').hide();
    });
    $('.pop-close2').click(function () {
        $('#record2').hide();
 
    });
    
    $('#kuang2 td').click(function () {
        document.getElementsByClassName("bgPop")[0].setAttribute("style","display:block")
        $('#kuang3').show();
    });
    
    $("#luxianku").on("click",".title",function(){
            var height;
            var li=$(this).next().find("li");
            height = li.length * 30 +25+ "px";
            if ($(this).next().css("height") === "0px") {
                $(this).next().css("height", height);
            } else {
              $(this).next().css("height", "0px");
            }
          }
    )

    //导出模板按钮 点选效果
    $('#import_imp').click(function (event) {
        var hei=$("#imp_template ul li").length*32+"px";
        $("#imp_template").css("height",hei);        
        event.stopPropagation();
    });
    $(document).on('click',':not(#import_imp)',function(){
        $("#imp_template").css("height","0px");
    })


//     $('#import_imp').click (event) ->
//     $("#imp_template").css("height",$("#imp_template ul li").length*32+"px")        
//     event.stopPropagation()
//   $(document).on 'click', ':not(#import_imp)', ->
//     $("#imp_template").css("height","0px");

//   $('#export_imp').click (event) ->
//     $("#exp_template").css("height",$("#exp_template ul li").length*32+"px")  
//     event.stopPropagation()
//   $(document).on 'click', ':not(#export_imp)', ->
//     $("#exp_template").css("height","0px");
  




    //导入模板按钮 点选效果
    $('#export_imp').click(function (event) {
        var hei=$("#exp_template ul li").length*32+"px";
        $("#exp_template").css("height",hei);        
        event.stopPropagation();
    });
    $(document).on('click',':not(#export_imp)',function(){
        $("#exp_template").css("height","0px");
    })

    //巡检模式 点选效果
    $("#map_path_option li").click(function(e){
        var value=$(this).attr("data-chose");
        $("#map_path_select").text(value);
    })
    $("#map_path_select").click(function(e){
        var height=$("#map_path_option li").length*28+2+"px"
        $("#map_path_option").css("border","1px solid rgb(20,221,231)")
        $("#map_path_option").css("height",height)
    })
    $(document).on('click',':not(#map_path_select)',function(){
        $("#map_path_option").css("height","0px");
        $("#map_path_option").css("border","0px")
    })
    $("#map_path_select").click(function(event){
        event.stopPropagation();
    });


    // 命名组 点选效果
    $('#map_name_select').click(function () {
        $("#map_name_option").css("display","block");
        $("#map_name_option li").css("display","block");
    });
    $(document).on('click',':not(.map_name_view)',function(){
            $("#map_name_option").css("display","none");
            $("#map_name_option li").css("display","none");
        })
})

    //kuang3标签测点 点选效果
    $("#spot_test_option li").click(function(e){
        var value=$(this).attr("data-chose");
        $("#spot_test_select").text(value);
    })
    $("#spot_test_select").click(function(e){
        var height=$("#spot_test_option li").length*28+2+"px"
        $("#spot_test_option").css("border","1px solid rgb(20,221,231)")
        $("#spot_test_option").css("height",height)
    })
    $("#kuang3").on('click',':not(#spot_test_select)',function(){
        $("#spot_test_option").css("height","0px");
        $("#spot_test_option").css("border","0px")
    })
    $("#spot_test_select").click(function(event){
        event.stopPropagation();
    });





    // function luxian_type_title() {   //.titlt高度
    //     for (var i = 0; i < $(".luxian_type").length; i++) {
    //         var height = $(".luxian_type").eq(i).css("height");
    //         $(".luxian_type .title").eq(i).css("height", height);
    //     }
    // }luxian_type_title();



    //路线模式的点选效果及所选的type
    var nowMapType=null;
    function liClick(x){
        for(var i=0;i<3;i++){
            $("#map_select li").removeClass("looking");   
            }
        $(x).addClass("looking");
        nowMapType=x;
    }
    
    function mapNameclick(x){
        for(var i=0;i<3;i++){
            $("#map_name_option li").removeClass("looking");   
            }
        $(x).addClass("looking");
        $("#map_name_select>span").eq(0).text( $(x).attr("data-chose") );
    }
    
    
     

       
    
    
    //按照巡检点数量生成不同路线框图
    var num
    function creatMap(){  //生成路线框图
        if( $("#map_num>input").eq(0).val()==0){
            alert("请输入框图数目")
            return
        }
        num=$("#map_num>input").eq(0).val();
        objMap.num=num;
        var lie;    if(num>=5) lie=5;else lie=num;
        var hang;   hang=Math.ceil(num/5);
        var tab="<table id=\"map\"> "
        
    
       
        for (i = 0; i < objMap.num; i++) {
            //为objMap添加spot
            var objSpot = {
                    "id": 1,
                    "name": "",
                    "desc": "",
                    "tmp": false,
                    "created_at": "",
                    "updated_at": "",
                    "items": []
            };
            objMap.spots.push(objSpot);
        }


        for(var i=1;i<=hang;i++)   //生成框
        {
            tab+="<tr>";

            if(i==hang&&num%5!=0){  //最后一行框数    
                lie=num%5;
                }
            for(var j=1;j<=lie;j++)
            {
                tab+="<td><div onclick=\"up(this)\" ><span></span><img class=\"jiantou\"></div></td>";
            }
            tab+="</tr>";
        }           
        tab+="</table>"
        document.getElementById("kuang2").innerHTML=tab;
    
        for(var h=0;h<num;h++){//奇数行左浮动，偶数行右浮动
            if(Math.ceil((h+1)/5) %2 !=0 ){
                document.getElementById("map").getElementsByTagName("td")[h].setAttribute('style','float:left');
            }
            else{
                document.getElementById("map").getElementsByTagName("td")[h].setAttribute('style','float:right');
            }
        }
        for(h=0;h<document.getElementById("map").getElementsByTagName("div").length;h++){
            document.getElementById("map").getElementsByTagName("div")[h].setAttribute("data-spot-seq",h)//为框图添加序号
        }

        jiantou(num);
    }
    
    function jiantou(num){  //为路线框图添加箭头
        for(var i=0;i<num;i++){
            if(Math.ceil((i+1)/5)%2!=0 && i%10!=4 && i%10!=9){ //奇数行
                document.getElementsByClassName("jiantou")[i].setAttribute("src","../img/2-2-jiantou.png")
            }
            else if(Math.ceil((i+1)/5)%2==0 && i%10!=4 && i%10!=9 ){//偶数行
                document.getElementsByClassName("jiantou")[i].setAttribute("src","../img/2-2-jiantou2.png")
                document.getElementsByClassName("jiantou")[i].setAttribute("style","left:-76px;top:-35px")
            }  
            else if(i%10==4 || i%10==9){//指向下一行的交接箭头
                document.getElementsByClassName("jiantou")[i].setAttribute("src","../img/2-2-jiantou5.png")
                document.getElementsByClassName("jiantou")[i].setAttribute("style","left:0px;top:-9px;width:14%")
            }   
        }
        document.getElementsByClassName("jiantou")[num-1].setAttribute("src","");

    }
    

    var kuangx;//当前选中的框
    function up(x){  //点击框图，弹出书写框
        //先清空书写框
        var input=document.getElementById("kuang3").getElementsByTagName("input"); 
        for(var j=0;j<input.length;j++){
            input[j].value="";
        }
        //书写框出现，遮掩层出现
        document.getElementById("kuang3").setAttribute("style","display:block");
        document.getElementsByClassName("bgPop")[0].setAttribute("style","display:block");
        
        kuangx=x;
        
        //把objMap的数据输入到书写框里
        $("#spot_name").val(objMap.spots[kuangx.getAttribute("data-spot-seq")].name)
        $("#spot_desc").val(objMap.spots[kuangx.getAttribute("data-spot-seq")].desc)
        for(var i=0;i<$(".creat_new_item").length;i++){    
            $(".creat_new_item:eq("+i+") input:eq(0)").val(objMap.spots[kuangx.getAttribute("data-spot-seq")].items[i].content)
            $(".creat_new_item:eq("+i+") input:eq(1)").val(objMap.spots[kuangx.getAttribute("data-spot-seq")].items[i].unit)
            $(".creat_new_item:eq("+i+") input:eq(2)").val(objMap.spots[kuangx.getAttribute("data-spot-seq")].items[i].st_min)
            $(".creat_new_item:eq("+i+") input:eq(3)").val(objMap.spots[kuangx.getAttribute("data-spot-seq")].items[i].st_max)
            $(".creat_new_item:eq("+i+") input:eq(4)").val(objMap.spots[kuangx.getAttribute("data-spot-seq")].items[i].al_min)
            $(".creat_new_item:eq("+i+") input:eq(5)").val(objMap.spots[kuangx.getAttribute("data-spot-seq")].items[i].al_max)
        }
    }
    function saveItem(){  //保存数据到spot
        
        var text="";
        text=text+document.getElementById("spot_name").value;
        kuangx.getElementsByTagName('span')[0].innerHTML=text; //spot.name放到对应框图中
        
        objMap.spots[kuangx.getAttribute("data-spot-seq")].items=[]  //清空objMap.spots[kuangx.getAttribute("data-spot-seq")].items

        for(var i=0;i<$(".creat_new_item").length;i++){ 
            //各item的数据保存到spot
            var item={};
            item.content=$(".creat_new_item:eq("+i+") input:eq(0)").val()
            item.unit=$(".creat_new_item:eq("+i+") input:eq(1)").val()
            item.itemtype="false"
            item.st_min=$(".creat_new_item:eq("+i+") input:eq(2)").val()
            item.st_max=$(".creat_new_item:eq("+i+") input:eq(3)").val()
            item.al_min=$(".creat_new_item:eq("+i+") input:eq(4)").val()
            item.al_max=$(".creat_new_item:eq("+i+") input:eq(5)").val()
            item.id=i+1
            objMap.spots[kuangx.getAttribute("data-spot-seq")].items.push(item);
        }
        
        objMap.spots[kuangx.getAttribute("data-spot-seq")].name=$("#spot_name").val();
        objMap.spots[kuangx.getAttribute("data-spot-seq")].desc=$("#spot_desc").val();
        objMap.spots[kuangx.getAttribute("data-spot-seq")].id=parseInt(kuangx.getAttribute("data-spot-seq"))+1
        console.log($(".creat_new_item") )        
    }
    function del(){  //清空某spot         
        var input=document.getElementById("kuang3").getElementsByTagName("input");        
        for(var i=0;i<input.length;i++){
            input[i].value="";
        }//清空kuang3所有输入框
        
        $("#spot_guding select:eq(0)").val("0");
        objMap.spots[kuangx.getAttribute("data-spot-seq")].items=[]  //清空objMap.spots[].items        
        $(".creat_new_item").remove();//清除div-item
        saveItem()
    }
    
    var model=document.getElementsByClassName("creat_new_item")[0];
    function addItem(){
        var new_item=model.cloneNode(true);
        document.getElementById("kuang3_items").appendChild(new_item);
        saveItem();
    }
    
    function delItem(x){
        x.parentNode.parentNode.parentNode.removeChild(x.parentNode.parentNode);
        saveItem()
    }



    function ku_del(x){
        x.parentNode.parentNode.removeChild(x.parentNode);
    }



    function addMapType(evt){   //
        e=window.event||evt;
        
        
        if(e.keyCode == 13){ 
            var name=$(".creat_new_type:eq(0) textarea:eq(0)").val();
            var model = " \n<div class=\"luxian_type\">\n<div class=\"title\">" + name + "</div>\n<ul ></ul>\n</div>\n";
            $(".luxian_type:last").before(model)
            $(".creat_new_type:eq(0) textarea:eq(0)").val("")          
        }
        // fresh() 
    }
  
    
   


    function creatGraph2(spots) {
        var text = "";
        for (var j = 0; j < spots.length; j++) {
            var tab = "<table > \n                    <thead><tr><th>" + spots[j].name + "</th></tr></thead>"; //标题(spot名)
    
            for (var i = 0; i < spots[j].items.length; i++) {
                tab += "<tr>";
                tab += "<td>" + spots[j].items[i].content + "</td>";
    
                if (spots[j].items[i].pass == true) {
    
                    if (spots[j].items[i].value == false) {
                        tab += "<td >\u901A\u8FC7</td>";
                    } else {
                        tab += "<td>\n <div class=\"value value_left \">\u5DE1\u68C0\u503C\uFF1A " + spots[j].items[i].data + "</div>\n                                <div class=\"value value_right\">\u6807\u51C6\u503C\uFF1A" + spots[j].items[i].st_max + " \u8B66\u6212\u503C\uFF1A" + spots[j].items[i].al_max + "</div>\n                            </td>";
                    }
                } else {
                    if (spots[j].items[i].value == false) {
                        tab += "<td class=\"no_pass\">\u672A\u901A\u8FC7</td>";
                    } else {
                        tab += "<td>\n   <div class=\"value value_left no_pass\">\u5DE1\u68C0\u503C\uFF1A " + spots[j].items[i].data + "</div>\n                                <div class=\"value value_right\">\u6807\u51C6\u503C\uFF1A" + spots[j].items[i].st_max + " \u8B66\u6212\u503C\uFF1A" + spots[j].items[i].al_max + "</div>\n                            </td> ";
                    }
                }
            }
            tab += "</table>";
            text += tab;
        }
        document.getElementById("graph2").innerHTML = text;
    }
    creatGraph2(objMap.spots);


